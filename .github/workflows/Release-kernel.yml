name: Create Kernel Release GitHub
on:
Â Â workflow_dispatch:
Â Â Â Â inputs:
Â Â Â Â Â Â build_run_url:
Â Â Â Â Â Â Â Â description: 'URL of the successful build run (e.g., https://github.com/user/repo/actions/runs/12345)'
Â Â Â Â Â Â Â Â required: true
Â Â Â Â Â Â Â Â type: string

jobs:
Â Â release:
Â Â Â Â name: Create GitHub Release
Â Â Â Â runs-on: ubuntu-latest
Â Â Â Â permissions:
Â Â Â Â Â Â contents: write
Â Â Â Â Â Â actions: read
Â Â Â Â env:
Â Â Â Â Â Â TZ: Asia/Kolkata
Â Â Â Â Â Â GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
Â Â Â Â outputs:
Â Â Â Â Â Â release_tag: ${{ steps.generate_tag.outputs.tag }}
Â Â Â Â Â Â telegram_notes: ${{ steps.prep_telegram_notes.outputs.notes }} # <-- CHANGE: Outputting the special Telegram notes

    steps:
      - name: 1. Parse Run ID from URL
        id: parse_url
        run: |
          BUILD_URL="${{ github.event.inputs.build_run_url }}"
          if [[ ! "$BUILD_URL" =~ ^https://github.com/.*/actions/runs/[0-9]+$ ]]; then
            echo "::error::Invalid GitHub Actions run URL provided."
            exit 1
          fi
          RUN_ID=$(basename "$BUILD_URL")
          echo "Extracted Run ID: $RUN_ID"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

Â Â Â Â Â Â - name: 2. Send Start Notification
Â Â Â Â Â Â Â Â uses: appleboy/telegram-action@master
Â Â Â Â Â Â Â Â with:
Â Â Â Â Â Â Â Â Â Â to: ${{ secrets.TELEGRAM_CHAT_ID_PERSONAL }}
Â Â Â Â Â Â Â Â Â Â token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
Â Â Â Â Â Â Â Â Â Â format: markdown
Â Â Â Â Â Â Â Â Â Â message: |
Â Â Â Â Â Â Â Â Â Â Â Â *ðŸš€ Manual Release Process Started*
Â Â Â Â Â Â Â Â Â Â Â Â ------------------------------------
Â Â Â Â Â Â Â Â Â Â Â Â Downloading artifacts from Run ID: `${{ steps.parse_url.outputs.run_id }}`
Â Â Â Â Â Â Â Â Â Â Â Â [View Release Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

Â Â Â Â Â Â - name: 3. Checkout Repository
Â Â Â Â Â Â Â Â uses: actions/checkout@v4

Â Â Â Â Â Â - name: 4. Generate IST Release Tag
Â Â Â Â Â Â Â Â id: generate_tag
Â Â Â Â Â Â Â Â run: |
Â Â Â Â Â Â Â Â Â Â TAG="oneplus_nord_4-$(date +'%Y-%m-%d_%H-%M')-IST"
Â Â Â Â Â Â Â Â Â Â echo "Generated Tag: $TAG"
Â Â Â Â Â Â Â Â Â Â echo "tag=$TAG" >> $GITHUB_OUTPUT

Â Â Â Â Â Â - name: 5. Download Build Artifacts
Â Â Â Â Â Â Â Â run: |
Â Â Â Â Â Â Â Â Â Â echo "Downloading artifacts from Run ID ${{ steps.parse_url.outputs.run_id }}..."
Â Â Â Â Â Â Â Â Â Â gh run download ${{ steps.parse_url.outputs.run_id }} --dir ./downloaded-artifacts --repo ${{ github.repository }}

Â Â Â Â Â Â - name: 6. Display Downloaded Artifact Structure
Â Â Â Â Â Â Â Â run: ls -R ./downloaded-artifacts

Â Â Â Â Â Â - name: 7. Zip Each Artifact Individually
Â Â Â Â Â Â Â Â run: |
Â Â Â Â Â Â Â Â Â Â mkdir ./final-zips
Â Â Â Â Â Â Â Â Â Â for dir in ./downloaded-artifacts/*; do
Â Â Â Â Â Â Â Â Â Â Â Â if [ -d "$dir" ]; then
Â Â Â Â Â Â Â Â Â Â Â Â Â Â ARTIFACT_NAME=$(basename "$dir")
Â Â Â Â Â Â Â Â Â Â Â Â Â Â (cd "$dir" && zip -r9 "$GITHUB_WORKSPACE/final-zips/${ARTIFACT_NAME}.zip" .)
Â Â Â Â Â Â Â Â Â Â Â Â fi
Â Â Â Â Â Â Â Â Â Â done
Â Â Â Â Â Â 
Â Â Â Â Â Â # <-- CHANGE: This step now ONLY prepares notes for the GitHub Release page.
Â Â Â Â Â Â - name: 8. Prepare GitHub Release Notes
Â Â Â Â Â Â Â Â id: prep_github_notes
Â Â Â Â Â Â Â Â run: |
Â Â Â Â Â Â Â Â Â Â NOTES=$(cat <<'EOF'
Â Â Â Â Â Â Â Â Â Â ### SukiSU Ultra Kernel for OnePlus Nord 4
Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â #### Flash this kernel on 15.0.0.701
Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â **Flasher Recommendation:**
Â Â Â Â Â Â Â Â Â Â * [Kernel Flasher](https://github.com/fatalcoder524/KernelFlasher/releases)
Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â **Manager App:**
Â Â Â Â Â Â Â Â Â Â * [SukiSU-Ultra Manager](https://github.com/SukiSU-Ultra/SukiSU-Ultra/releases)

Â Â Â Â Â Â Â Â Â Â **Sufs Module:**
Â Â Â Â Â Â Â Â Â Â * [Susfs Module](https://github.com/sidex15/susfs4ksu-module/releases)
Â Â Â Â Â Â Â Â Â Â EOF
Â Â Â Â Â Â Â Â Â Â )
Â Â Â Â Â Â Â Â Â Â echo "notes<<EOF" >> $GITHUB_OUTPUT
Â Â Â Â Â Â Â Â Â Â echo "$NOTES" >> $GITHUB_OUTPUT
Â Â Â Â Â Â Â Â Â Â echo "EOF" >> $GITHUB_OUTPUT

Â Â Â Â Â Â # <-- CHANGE: This is a NEW step to prepare the separate, Telegram-safe notes.
Â Â Â Â Â Â - name: 9. Prepare Telegram Notification Notes
Â Â Â Â Â Â Â Â id: prep_telegram_notes
Â Â Â Â Â Â Â Â run: |
Â Â Â Â Â Â Â Â Â Â NOTES=$(cat <<'EOF'
Â Â Â Â Â Â Â Â Â Â *SukiSU Ultra Kernel for OnePlus Nord 4*
Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â *Flash this kernel on 15.0.0.702*
Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â *Flasher Recommendation:*
Â Â Â Â Â Â Â Â Â Â â€¢ [Kernel Flasher](https://github.com/fatalcoder524/KernelFlasher/releases)
Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â *Manager App:*
Â Â Â Â Â Â Â Â Â Â â€¢ [SukiSU-Ultra Manager](https://github.com/SukiSU-Ultra/SukiSU-Ultra/releases)

Â Â Â Â Â Â Â Â Â Â *Sufs Module:*
Â Â Â Â Â Â Â Â Â Â â€¢ [Susfs Module](https://github.com/sidex15/susfs4ksu-module/releases)
Â Â Â Â Â Â Â Â Â Â EOF
Â Â Â Â Â Â Â Â Â Â )
Â Â Â Â Â Â Â Â Â Â echo "notes<<EOF" >> $GITHUB_OUTPUT
Â Â Â Â Â Â Â Â Â Â echo "$NOTES" >> $GITHUB_OUTPUT
Â Â Â Â Â Â Â Â Â Â echo "EOF" >> $GITHUB_OUTPUT

Â Â Â Â Â Â # <-- CHANGE: This step now uses the GitHub-specific notes from step 8.
Â Â Â Â Â Â - name: 10. Create GitHub Release and Upload Zips
Â Â Â Â Â Â Â Â run: |
Â Â Â Â Â Â Â Â Â Â gh release create "${{ steps.generate_tag.outputs.tag }}" \
Â Â Â Â Â Â Â Â Â Â Â Â --title "Kernel Release - $(date +'%d %B %Y')" \
Â Â Â Â Â Â Â Â Â Â Â Â --notes "${{ steps.prep_github_notes.outputs.notes }}" \
Â Â Â Â Â Â Â Â Â Â Â Â ./final-zips/*.zip
Â Â 
Â Â notify_result:
Â Â Â Â name: Notify Final Release Status
Â Â Â Â needs: release
Â Â Â Â if: always()
Â Â Â Â runs-on: ubuntu-latest
Â Â Â Â steps:
Â Â Â Â Â Â - name: Send Final Release Notification
Â Â Â Â Â Â Â Â uses: appleboy/telegram-action@master
Â Â Â Â Â Â Â Â with:
Â Â Â Â Â Â Â Â Â Â to: ${{ needs.release.result == 'success' && secrets.TELEGRAM_CHAT_ID_PERSONAL && secrets.TELEGRAM_CHAT_ID_PERSONAL }}
Â Â Â Â Â Â Â Â Â Â token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
Â Â Â Â Â Â Â Â Â Â format: markdown
Â Â Â Â Â Â Â Â Â Â # <-- CHANGE: The message now correctly uses the special 'telegram_notes' output.
Â Â Â Â Â Â Â Â Â Â message: |
Â Â Â Â Â Â Â Â Â Â Â Â ${{ needs.release.result == 'success' && format('ðŸŽ‰ *New Kernel Release!*
Â Â Â Â Â Â Â Â Â Â Â Â ------------------------------------
Â Â Â Â Â Â Â Â Â Â Â Â A new kernel for *OnePlus Nord 4* has been successfully released.

Â Â Â Â Â Â Â Â Â Â Â Â {2}

Â Â Â Â Â Â Â Â Â Â Â Â *Release Tag:* `{0}`
Â Â Â Â Â Â Â Â Â Â Â Â ------------------------------------
Â Â Â Â Â Â Â Â Â Â Â Â [â¬‡ï¸ Download from GitHub Releases](https://github.com/{1}/releases/tag/{0})', needs.release.outputs.release_tag, github.repository, needs.release.outputs.telegram_notes) || '' }}

Â Â Â Â Â Â Â Â Â Â Â Â ${{ needs.release.result == 'failure' && format('âŒ *Release Failed!*
Â Â Â Â Â Â Â Â Â Â Â Â ------------------------------------
Â Â Â Â Â Â Â Â Â Â Â Â The final step of creating the GitHub Release failed. Check the logs for details.
Â Â Â Â Â Â Â Â Â Â Â Â [View Logs](https://github.com/{0}/actions/runs/{1})', github.repository, github.run_id) || '' }}
            
